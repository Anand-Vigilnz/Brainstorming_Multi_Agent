services:
  # Architect Agent
  architect-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: product-dev-architect-agent
    command: python -m architect_agent
    ports:
      - "9991:9991"
    environment:
      - ARCHITECT_AGENT_PORT=9991
      - ARCHITECT_AGENT_NAME=Architect Agent
      - ARCHITECT_AGENT_URL=http://architect-agent:9991
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
    volumes:
      - ./logs:/app/logs
      - ./architect_agent/.env:/app/architect_agent/.env:ro
    networks:
      - product-dev-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9991/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Developer Agent
  developer-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: product-dev-developer-agent
    command: python -m developer_agent
    ports:
      - "9992:9992"
    environment:
      - DEVELOPER_AGENT_PORT=9992
      - DEVELOPER_AGENT_NAME=Developer Agent
      - DEVELOPER_AGENT_URL=http://developer-agent:9992
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
    volumes:
      - ./logs:/app/logs
      - ./developer_agent/.env:/app/developer_agent/.env:ro
    networks:
      - product-dev-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9992/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Tester Agent
  tester-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: product-dev-tester-agent
    command: python -m tester_agent
    ports:
      - "9993:9993"
    environment:
      - TESTER_AGENT_PORT=9993
      - TESTER_AGENT_NAME=Tester Agent
      - TESTER_AGENT_URL=http://tester-agent:9993
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
    volumes:
      - ./logs:/app/logs
      - ./tester_agent/.env:/app/tester_agent/.env:ro
    networks:
      - product-dev-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9993/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Host Agent (Orchestrator/Product Owner)
  host-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: product-dev-host-agent
    command: python -m host_agent
    ports:
      - "9999:9999"
    environment:
      - HOST_AGENT_PORT=9999
      - HOST_AGENT_NAME=Product Development Orchestrator
      - ARCHITECT_AGENT_URL=http://architect-agent:9991
      - DEVELOPER_AGENT_URL=http://developer-agent:9992
      - TESTER_AGENT_URL=http://tester-agent:9993
    volumes:
      - ./logs:/app/logs
      - ./host_agent/.env:/app/host_agent/.env:ro
    networks:
      - product-dev-network
    depends_on:
      architect-agent:
        condition: service_healthy
      developer-agent:
        condition: service_healthy
      tester-agent:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9999/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Streamlit UI
  streamlit-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: product-dev-streamlit-ui
    command: streamlit run streamlit_app/app.py --server.port=8501 --server.address=0.0.0.0 --server.headless=true
    ports:
      - "8501:8501"
    environment:
      - HOST_AGENT_URL=${HOST_AGENT_URL}
      - ARCHITECT_AGENT_URL=${ARCHITECT_AGENT_URL}
      - DEVELOPER_AGENT_URL=${DEVELOPER_AGENT_URL}
      - TESTER_AGENT_URL=${TESTER_AGENT_URL}
      - API_KEY=${API_KEY}
    volumes:
      - ./logs:/app/logs
      - ./streamlit_app/.env:/app/streamlit_app/.env:ro
    networks:
      - product-dev-network
    depends_on:
      host-agent:
        condition: service_healthy
    restart: unless-stopped

  # Nginx Reverse Proxy (Optional but recommended for production)
  nginx:
    image: nginx:alpine
    container_name: product-dev-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - product-dev-network
    depends_on:
      - streamlit-app
    restart: unless-stopped

networks:
  product-dev-network:
    driver: bridge

volumes:
  logs:
    driver: local